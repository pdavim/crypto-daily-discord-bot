<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Source: index.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="light"><div class="sidebar-container"><div class="sidebar" id="sidebar"><a href="/" class="sidebar-title sidebar-title-anchor">Crypto Daily Discord Bot API</a><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="DiscordRateLimit.html">DiscordRateLimit</a></div><div class="sidebar-section-children"><a href="TokenBucket.html">TokenBucket</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#AssetRunner">AssetRunner</a></div><div class="sidebar-section-children"><a href="global.html#LimitExecutor">LimitExecutor</a></div><div class="sidebar-section-children"><a href="global.html#LimitFactory">LimitFactory</a></div><div class="sidebar-section-children"><a href="global.html#SnapshotMap">SnapshotMap</a></div><div class="sidebar-section-children"><a href="global.html#TimeframeSnapshot">TimeframeSnapshot</a></div><div class="sidebar-section-children"><a href="global.html#addAssetToWatch">addAssetToWatch</a></div><div class="sidebar-section-children"><a href="global.html#adx">adx</a></div><div class="sidebar-section-children"><a href="global.html#assetMetadata">assetMetadata</a></div><div class="sidebar-section-children"><a href="global.html#atr14">atr14</a></div><div class="sidebar-section-children"><a href="global.html#bollWidth">bollWidth</a></div><div class="sidebar-section-children"><a href="global.html#bollinger">bollinger</a></div><div class="sidebar-section-children"><a href="global.html#build45mCandles">build45mCandles</a></div><div class="sidebar-section-children"><a href="global.html#buildAlerts">buildAlerts</a></div><div class="sidebar-section-children"><a href="global.html#buildHash">buildHash</a></div><div class="sidebar-section-children"><a href="global.html#buildPortfolioGrowthDiscordMessage">buildPortfolioGrowthDiscordMessage</a></div><div class="sidebar-section-children"><a href="global.html#buildSnapshotForReport">buildSnapshotForReport</a></div><div class="sidebar-section-children"><a href="global.html#buildSummary">buildSummary</a></div><div class="sidebar-section-children"><a href="global.html#buildSummaryPdf">buildSummaryPdf</a></div><div class="sidebar-section-children"><a href="global.html#calcConcurrency">calcConcurrency</a></div><div class="sidebar-section-children"><a href="global.html#callOpenRouter">callOpenRouter</a></div><div class="sidebar-section-children"><a href="global.html#cci">cci</a></div><div class="sidebar-section-children"><a href="global.html#clampSentiment">clampSentiment</a></div><div class="sidebar-section-children"><a href="global.html#classifySentimentsLocal">classifySentimentsLocal</a></div><div class="sidebar-section-children"><a href="global.html#collectVariationMetrics">collectVariationMetrics</a></div><div class="sidebar-section-children"><a href="global.html#compareAssets">compareAssets</a></div><div class="sidebar-section-children"><a href="global.html#compileMonthlyPerformanceReport">compileMonthlyPerformanceReport</a></div><div class="sidebar-section-children"><a href="global.html#computeWeightedSentiment">computeWeightedSentiment</a></div><div class="sidebar-section-children"><a href="global.html#crossDown">crossDown</a></div><div class="sidebar-section-children"><a href="global.html#crossUp">crossUp</a></div><div class="sidebar-section-children"><a href="global.html#ema">ema</a></div><div class="sidebar-section-children"><a href="global.html#fetchWithRetry">fetchWithRetry</a></div><div class="sidebar-section-children"><a href="global.html#filterFreshNewsItems">filterFreshNewsItems</a></div><div class="sidebar-section-children"><a href="global.html#fmt">fmt</a></div><div class="sidebar-section-children"><a href="global.html#forecastNextClose">forecastNextClose</a></div><div class="sidebar-section-children"><a href="global.html#formatAlertMessage">formatAlertMessage</a></div><div class="sidebar-section-children"><a href="global.html#generateWeeklySnapshot">generateWeeklySnapshot</a></div><div class="sidebar-section-children"><a href="global.html#getAlertHash">getAlertHash</a></div><div class="sidebar-section-children"><a href="global.html#getAssetNews">getAssetNews</a></div><div class="sidebar-section-children"><a href="global.html#getSetting">getSetting</a></div><div class="sidebar-section-children"><a href="global.html#getSettings">getSettings</a></div><div class="sidebar-section-children"><a href="global.html#getSignature">getSignature</a></div><div class="sidebar-section-children"><a href="global.html#getWatchlist">getWatchlist</a></div><div class="sidebar-section-children"><a href="global.html#handleAnalysisSlashCommand">handleAnalysisSlashCommand</a></div><div class="sidebar-section-children"><a href="global.html#handleInteraction">handleInteraction</a></div><div class="sidebar-section-children"><a href="global.html#initBot">initBot</a></div><div class="sidebar-section-children"><a href="global.html#isBBSqueeze">isBBSqueeze</a></div><div class="sidebar-section-children"><a href="global.html#keltnerChannel">keltnerChannel</a></div><div class="sidebar-section-children"><a href="global.html#limit">limit</a></div><div class="sidebar-section-children"><a href="global.html#loadSettings">loadSettings</a></div><div class="sidebar-section-children"><a href="global.html#loadWeeklySnapshots">loadWeeklySnapshots</a></div><div class="sidebar-section-children"><a href="global.html#macd">macd</a></div><div class="sidebar-section-children"><a href="global.html#markNewsItemsAsSeen">markNewsItemsAsSeen</a></div><div class="sidebar-section-children"><a href="global.html#monthKeyFromIso">monthKeyFromIso</a></div><div class="sidebar-section-children"><a href="global.html#normalizeSentiment">normalizeSentiment</a></div><div class="sidebar-section-children"><a href="global.html#notifyOps">notifyOps</a></div><div class="sidebar-section-children"><a href="global.html#num">num</a></div><div class="sidebar-section-children"><a href="global.html#obv">obv</a></div><div class="sidebar-section-children"><a href="global.html#parabolicSAR">parabolicSAR</a></div><div class="sidebar-section-children"><a href="global.html#pct">pct</a></div><div class="sidebar-section-children"><a href="global.html#persistForecastEntry">persistForecastEntry</a></div><div class="sidebar-section-children"><a href="global.html#postAnalysis">postAnalysis</a></div><div class="sidebar-section-children"><a href="global.html#postCharts">postCharts</a></div><div class="sidebar-section-children"><a href="global.html#postMonthlyReport">postMonthlyReport</a></div><div class="sidebar-section-children"><a href="global.html#previousMonthKey">previousMonthKey</a></div><div class="sidebar-section-children"><a href="global.html#pruneOlderThan">pruneOlderThan</a></div><div class="sidebar-section-children"><a href="global.html#recordPerf">recordPerf</a></div><div class="sidebar-section-children"><a href="global.html#removeAssetFromWatch">removeAssetFromWatch</a></div><div class="sidebar-section-children"><a href="global.html#renderChartPNG">renderChartPNG</a></div><div class="sidebar-section-children"><a href="global.html#renderForecastChart">renderForecastChart</a></div><div class="sidebar-section-children"><a href="global.html#renderMonthlyPerformanceChart">renderMonthlyPerformanceChart</a></div><div class="sidebar-section-children"><a href="global.html#renderPortfolioGrowthChart">renderPortfolioGrowthChart</a></div><div class="sidebar-section-children"><a href="global.html#reportWeeklyPerf">reportWeeklyPerf</a></div><div class="sidebar-section-children"><a href="global.html#resetAlertHashes">resetAlertHashes</a></div><div class="sidebar-section-children"><a href="global.html#resetSettings">resetSettings</a></div><div class="sidebar-section-children"><a href="global.html#roundThreshold">roundThreshold</a></div><div class="sidebar-section-children"><a href="global.html#rsi">rsi</a></div><div class="sidebar-section-children"><a href="global.html#runAgent">runAgent</a></div><div class="sidebar-section-children"><a href="global.html#runAll">runAll</a></div><div class="sidebar-section-children"><a href="global.html#runAssetsSafely">runAssetsSafely</a></div><div class="sidebar-section-children"><a href="global.html#runDailyAnalysis">runDailyAnalysis</a></div><div class="sidebar-section-children"><a href="global.html#runOnceForAsset">runOnceForAsset</a></div><div class="sidebar-section-children"><a href="global.html#saveStore">saveStore</a></div><div class="sidebar-section-children"><a href="global.html#saveWeeklySnapshot">saveWeeklySnapshot</a></div><div class="sidebar-section-children"><a href="global.html#scheduleRun">scheduleRun</a></div><div class="sidebar-section-children"><a href="global.html#scoreHeuristic">scoreHeuristic</a></div><div class="sidebar-section-children"><a href="global.html#searchWeb">searchWeb</a></div><div class="sidebar-section-children"><a href="global.html#semaforo">semaforo</a></div><div class="sidebar-section-children"><a href="global.html#sendDiscordAlert">sendDiscordAlert</a></div><div class="sidebar-section-children"><a href="global.html#setSetting">setSetting</a></div><div class="sidebar-section-children"><a href="global.html#shouldSend">shouldSend</a></div><div class="sidebar-section-children"><a href="global.html#sma">sma</a></div><div class="sidebar-section-children"><a href="global.html#sparkline">sparkline</a></div><div class="sidebar-section-children"><a href="global.html#stochastic">stochastic</a></div><div class="sidebar-section-children"><a href="global.html#streamKlines">streamKlines</a></div><div class="sidebar-section-children"><a href="global.html#tfToInterval">tfToInterval</a></div><div class="sidebar-section-children"><a href="global.html#toMonthKey">toMonthKey</a></div><div class="sidebar-section-children"><a href="global.html#trendFromMAs">trendFromMAs</a></div><div class="sidebar-section-children"><a href="global.html#updateAlertHash">updateAlertHash</a></div><div class="sidebar-section-children"><a href="global.html#updateSignature">updateSignature</a></div><div class="sidebar-section-children"><a href="global.html#volumeDivergence">volumeDivergence</a></div><div class="sidebar-section-children"><a href="global.html#vwap">vwap</a></div><div class="sidebar-section-children"><a href="global.html#williamsR">williamsR</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#dark-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">index.js</h1></header><article><pre class="prettyprint source lang-js"><code>import cron from "node-cron";
import http from "http";
import { CFG } from "./config.js";
import { ASSETS, TIMEFRAMES, BINANCE_INTERVALS } from "./assets.js";
import { fetchOHLCV, fetchDailyCloses } from "./data/binance.js";
import { streamKlines } from "./data/binanceStream.js";
import { sma, rsi, macd, bollinger, atr14, bollWidth, vwap, ema, adx, stochastic, williamsR, cci, obv, keltnerChannel } from "./indicators.js";
import { buildSnapshotForReport, buildSummary } from "./reporter.js";
import { postAnalysis, sendDiscordAlert, postMonthlyReport } from "./discord.js";
import { postCharts, initBot } from "./discordBot.js";
import { renderChartPNG, renderForecastChart } from "./chart.js";
import { buildAlerts } from "./alerts.js";
import { runAgent } from "./ai.js";
import { getSignature, updateSignature, saveStore, getAlertHash, updateAlertHash, resetAlertHashes } from "./store.js";
import { fetchEconomicEvents } from "./data/economic.js";
import { logger, withContext } from "./logger.js";
import pLimit, { calcConcurrency } from "./limit.js";
import { buildHash, shouldSend, pruneOlderThan } from "./alertCache.js";
import { register, forecastConfidenceHistogram, forecastDirectionCounter, forecastErrorHistogram } from "./metrics.js";
import { notifyOps } from "./monitor.js";
import { reportWeeklyPerf } from "./perf.js";
import { saveWeeklySnapshot, loadWeeklySnapshots } from "./weeklySnapshots.js";
import { renderMonthlyPerformanceChart } from "./monthlyReport.js";
import { runAssetsSafely } from "./runner.js";
import { enqueueAlertPayload, flushAlertQueue } from "./alerts/dispatcher.js";
import { buildAssetAlertMessage } from "./alerts/messageBuilder.js";
import { deriveDecisionDetails } from "./alerts/decision.js";
import { collectVariationMetrics } from "./alerts/variationMetrics.js";
import { evaluateMarketPosture, deriveStrategyFromPosture } from "./trading/posture.js";
import { automateTrading } from "./trading/automation.js";
import { forecastNextClose, persistForecastEntry } from "./forecasting.js";
import { runPortfolioGrowthSimulation } from "./portfolio/growth.js";

const ONCE = process.argv.includes("--once");

process.on('unhandledRejection', (err) => {
    const log = withContext(logger, { fn: 'unhandledRejection' });
    log.error({ err }, 'Unhandled promise rejection');
});

initBot({ onAnalysis: handleAnalysisSlashCommand });

if (!ONCE) {
    const METRICS_PORT = process.env.METRICS_PORT || 3001;
    http.createServer(async (req, res) => {
        if (req.method === 'GET' &amp;&amp; req.url === '/metrics') {
            res.setHeader('Content-Type', register.contentType);
            res.end(await register.metrics());
        } else {
            res.statusCode = 404;
            res.end('Not found');
        }
    }).listen(METRICS_PORT, () => {
        const log = withContext(logger);
        log.info({ fn: 'metrics' }, `Metrics server listening on port ${METRICS_PORT}`);
    });
}

/**
 * Converts an internal timeframe label into a Binance interval string.
 * @param {string} tf - Timeframe label (e.g. "4h").
 * @returns {string} Equivalent Binance interval.
 */
function tfToInterval(tf) { return BINANCE_INTERVALS[tf] || tf; }

/**
 * Aggregates 15 minute candles into 45 minute candles.
 * @param {Array&lt;{t: Date, o: number, h: number, l: number, c: number, v: number}>} candles15m - Source candles.
 * @returns {Array&lt;object>} Aggregated candle series.
 */
function build45mCandles(candles15m) {
    const out = [];
    for (let i = 0; i + 3 &lt;= candles15m.length; i += 3) {
        const slice = candles15m.slice(i, i + 3);
        out.push({
            t: slice[0].t,
            o: slice[0].o,
            h: Math.max(...slice.map(c => c.h)),
            l: Math.min(...slice.map(c => c.l)),
            c: slice[slice.length - 1].c,
            v: slice.reduce((sum, c) => sum + c.v, 0)
        });
    }
    return out;
}


/**
 * Performs the full analysis, alerting and chart generation pipeline for an asset.
 * @param {Object} asset - Asset metadata.
 * @param {string} asset.key - Asset identifier.
 * @param {string} asset.binance - Binance symbol.
 * @param {Object} [options={}] - Configuration flags controlling side effects.
 * @param {boolean} [options.enableCharts]
 * @param {boolean} [options.enableAlerts]
 * @param {boolean} [options.enableAnalysis]
 * @param {boolean} [options.postAnalysis]
 * @param {boolean} [options.postCharts]
 * @returns {Promise} Outputs generated by the run including snapshots, summary and chart paths.
 */
async function runOnceForAsset(asset, options = {}) {
    const {
        enableCharts = CFG.enableCharts,
        enableAlerts = CFG.enableAlerts,
        enableAnalysis = CFG.enableAnalysis,
        postAnalysis: shouldPostAnalysis = enableAnalysis,
        postCharts: shouldPostCharts = enableCharts
    } = options;
    const assetLog = withContext(logger, { asset: asset.key });
    const dailyPromise = fetchDailyCloses(asset.binance, 32).catch(err => {
        assetLog.warn({ fn: 'runOnceForAsset', err }, 'Daily closes unavailable; continuing without historical context');
        return [];
    });
    const snapshots = {};
    const chartPaths = [];
    const forecastChartPaths = [];
    const timeframeMeta = new Map();

    const intervalPromises = new Map();
    for (const tf of TIMEFRAMES) {
        const interval = tfToInterval(tf);
        if (!intervalPromises.has(interval)) {
            intervalPromises.set(interval, fetchOHLCV(asset.binance, interval));
        }
    }
    const intervalKeys = [...intervalPromises.keys()];
    let candlesByInterval;
    try {
        const intervalResults = await Promise.all(intervalKeys.map(k => intervalPromises.get(k)));
        candlesByInterval = new Map(intervalKeys.map((k, i) => [k, intervalResults[i]]));
    } catch (err) {
        assetLog.error({ fn: 'runOnceForAsset', err }, 'Failed to load price data for asset');
        await notifyOps(`Failed to load price data for ${asset.key}: ${err.message || err}`);
        return { snapshots: {}, summary: null, chartPaths: [] };
    }

    let cached45mCandles;
    const indicatorCache = new Map();

    const timeframeTasks = TIMEFRAMES.map(async tf => {
        const log = withContext(logger, { asset: asset.key, timeframe: tf });
        try {
            let candles;
            if (tf === "45m") {
                if (!cached45mCandles) {
                    const base = candlesByInterval.get(tfToInterval("15m"));
                    if (!base) {
                        return;
                    }
                    cached45mCandles = build45mCandles(base);
                }
                candles = cached45mCandles;
            } else {
                const interval = tfToInterval(tf);
                candles = candlesByInterval.get(interval);
            }
            const min = tf === "45m" ? 40 : 120;
            if (!candles || candles.length &lt; min) return;
            const lastCandleTime = candles.at(-1)?.t?.getTime?.();
            const key = `${asset.key}:${tf}`;
            if (lastCandleTime != null &amp;&amp; getSignature(key) === lastCandleTime) {
                return;
            }
            if (lastCandleTime != null) {
                updateSignature(key, lastCandleTime);
            }
            const close = candles.map(c => c.c);
            const vol = candles.map(c => c.v);
            const high = candles.map(c => c.h);
            const low = candles.map(c => c.l);

            const indicators = indicatorCache.get(tf) ?? (() => {
                const cfg = CFG.indicators;
                const ma20 = sma(close, cfg.smaPeriods.ma20);
                const ma50 = sma(close, cfg.smaPeriods.ma50);
                const ma100 = sma(close, cfg.smaPeriods.ma100);
                const ma200 = sma(close, cfg.smaPeriods.ma200);
                const rsiSeries = rsi(close, cfg.rsiPeriod);
                const macdObj = macd(close, cfg.macd.fast, cfg.macd.slow, cfg.macd.signal);
                const bb = bollinger(close, cfg.bollinger.period, cfg.bollinger.multiplier);
                const kc = keltnerChannel(close, high, low, cfg.keltner.period, cfg.keltner.multiplier);
                const adxSeries = adx(high, low, close, cfg.adxPeriod);
                const atrSeries = atr14(candles, cfg.atrPeriod);
                const bbWidth = bollWidth(bb.upper, bb.lower, bb.mid);
                const vwapSeries = vwap(high, low, close, vol);
                const ema9Series = ema(close, cfg.emaPeriods.ema9);
                const ema21Series = ema(close, cfg.emaPeriods.ema21);
                const { k: stochasticK, d: stochasticD } = stochastic(high, low, close, cfg.stochastic.kPeriod, cfg.stochastic.dPeriod);
                const willrSeries = williamsR(high, low, close, cfg.williamsPeriod);
                const cciSeries = cci(high, low, close, cfg.cciPeriod);
                const obvSeries = obv(close, vol);
                const computed = {
                    ma20,
                    ma50,
                    ma100,
                    ma200,
                    rsiSeries,
                    macdObj,
                    bb,
                    kc,
                    adxSeries,
                    atrSeries,
                    bbWidth,
                    vwapSeries,
                    ema9Series,
                    ema21Series,
                    stochasticK,
                    stochasticD,
                    willrSeries,
                    cciSeries,
                    obvSeries
                };
                indicatorCache.set(tf, computed);
                return computed;
            })();

            const daily = await dailyPromise;
            const snapshot = buildSnapshotForReport({
                candles,
                daily,
                ma20: indicators.ma20,
                ma50: indicators.ma50,
                ma100: indicators.ma100,
                ma200: indicators.ma200,
                rsi: indicators.rsiSeries,
                macdObj: indicators.macdObj,
                bb: indicators.bb,
                kc: indicators.kc,
                atr: indicators.atrSeries,
                adx: indicators.adxSeries,
                volSeries: vol
            });
            snapshots[tf] = snapshot;
            const variationMetrics = collectVariationMetrics({ snapshots });
            const timeframeVariation = snapshot?.kpis?.var ?? null;
            const guidance = snapshot?.kpis?.reco ?? null;

            const posture = evaluateMarketPosture({
                closes: close,
                maFastSeries: indicators.ma50,
                maSlowSeries: indicators.ma200,
                rsiSeries: indicators.rsiSeries,
                adxSeries: indicators.adxSeries,
                config: CFG.marketPosture,
            });
            const strategyPlan = deriveStrategyFromPosture(posture, CFG.trading?.strategy);
            log.info({
                fn: 'runOnceForAsset',
                posture: posture.posture,
                confidence: posture.confidence,
                strategy: strategyPlan.action,
            }, 'Evaluated market posture');

            const decision = deriveDecisionDetails({
                strategy: strategyPlan,
                posture,
            });

            const meta = {
                consolidated: [],
                actionable: [],
                guidance,
                variation: timeframeVariation,
                posture,
                strategy: strategyPlan,
                decision,
            };
            timeframeMeta.set(tf, meta);

            try {
                await automateTrading({
                    assetKey: asset.key,
                    symbol: asset.binance,
                    timeframe: tf,
                    decision,
                    posture,
                    strategy: strategyPlan,
                    snapshot,
                });
            } catch (err) {
                log.error({ fn: 'runOnceForAsset', err }, 'Automated trading failed');
            }

            if (enableCharts) {
                const chartPath = await renderChartPNG(asset.key, tf, candles, {
                    ma20: indicators.ma20,
                    ma50: indicators.ma50,
                    ma200: indicators.ma200,
                    bbUpper: indicators.bb.upper,
                    bbLower: indicators.bb.lower,
                });
                chartPaths.push(chartPath);
            }

            if (CFG.forecasting?.enabled) {
                const forecastLog = withContext(logger, { asset: asset.key, timeframe: tf });
                try {
                    const candleTimes = candles.map(c => c.t);
                    const forecastResult = forecastNextClose({
                        closes: close,
                        timestamps: candleTimes,
                        lookback: CFG.forecasting.lookback,
                        minHistory: CFG.forecasting.minHistory,
                    });
                    if (forecastResult) {
                        const runAtIso = new Date().toISOString();
                        const predictedAtIso = Number.isFinite(forecastResult.nextTime)
                            ? new Date(forecastResult.nextTime).toISOString()
                            : null;
                        const lastCloseIso = Number.isFinite(forecastResult.lastTime)
                            ? new Date(forecastResult.lastTime).toISOString()
                            : null;
                        const forecastEntry = {
                            runAt: runAtIso,
                            predictedAt: predictedAtIso,
                            lastCloseAt: lastCloseIso,
                            lastClose: forecastResult.lastClose,
                            forecastClose: forecastResult.forecast,
                            delta: forecastResult.delta,
                            confidence: forecastResult.confidence,
                            method: forecastResult.method,
                            samples: forecastResult.samples,
                            mae: forecastResult.mae,
                            rmse: forecastResult.rmse,
                            slope: forecastResult.slope,
                            intercept: forecastResult.intercept,
                            horizonMs: forecastResult.horizonMs,
                        };
                        const persistence = persistForecastEntry({
                            assetKey: asset.key,
                            timeframe: tf,
                            entry: forecastEntry,
                            directory: CFG.forecasting.outputDir,
                            historyLimit: CFG.forecasting.historyLimit,
                        });

                        meta.forecast = {
                            forecastClose: forecastResult.forecast,
                            lastClose: forecastResult.lastClose,
                            lastCloseAt: lastCloseIso,
                            delta: forecastResult.delta,
                            confidence: forecastResult.confidence,
                            predictedAt: predictedAtIso,
                            runAt: runAtIso,
                            method: forecastResult.method,
                            horizonMs: forecastResult.horizonMs,
                            samples: forecastResult.samples,
                            evaluation: persistence?.evaluation ?? null,
                            historyPath: persistence?.filePath ?? null,
                            timeZone: CFG.tz,
                        };

                        if (Number.isFinite(forecastResult.confidence)) {
                            forecastConfidenceHistogram.observe(forecastResult.confidence);
                        }

                        if (CFG.forecasting.charts?.enabled) {
                            const forecastChartPath = await renderForecastChart({
                                assetKey: asset.key,
                                timeframe: tf,
                                closes: close,
                                timestamps: candleTimes,
                                forecastValue: forecastResult.forecast,
                                forecastTime: forecastResult.nextTime,
                                confidence: forecastResult.confidence,
                                options: {
                                    directory: CFG.forecasting.charts.directory,
                                    historyPoints: CFG.forecasting.charts.historyPoints,
                                },
                            });
                            if (forecastChartPath) {
                                forecastChartPaths.push(forecastChartPath);
                            }
                        }

                        const evaluation = persistence?.evaluation ?? null;
                        if (evaluation &amp;&amp; Number.isFinite(evaluation.pctError)) {
                            forecastErrorHistogram.observe(evaluation.pctError);
                        }
                        if (evaluation &amp;&amp; typeof evaluation.directionHit === 'boolean') {
                            forecastDirectionCounter.labels(evaluation.directionHit ? 'hit' : 'miss').inc();
                        }

                        const logPayload = {
                            fn: 'runOnceForAsset',
                            forecast: forecastResult.forecast,
                            confidence: forecastResult.confidence,
                            delta: forecastResult.delta,
                            mae: forecastResult.mae,
                            rmse: forecastResult.rmse,
                            historyPath: persistence?.filePath ?? null,
                        };

                        if (evaluation) {
                            logPayload.accuracy = {
                                absError: evaluation.absError,
                                pctError: evaluation.pctError,
                                directionHit: evaluation.directionHit,
                            };
                            logPayload.actual = evaluation.actual;
                            logPayload.predictedAt = evaluation.predictedAt;
                            logPayload.actualAt = evaluation.actualAt;
                            forecastLog.info(logPayload, 'Generated forecast');
                        } else {
                            forecastLog.debug(logPayload, 'Generated forecast');
                        }

                    }
                } catch (err) {
                    forecastLog.error({ fn: 'runOnceForAsset', err }, 'Forecast generation failed');
                }
            }

            if (enableAlerts) {
                const alerts = await buildAlerts({
                    rsiSeries: indicators.rsiSeries,
                    macdObj: indicators.macdObj,
                    bbWidth: indicators.bbWidth,
                    ma20: indicators.ma20,
                    ma50: indicators.ma50,
                    ma200: indicators.ma200,
                    lastClose: snapshot.kpis.price,
                    var24h: snapshot.kpis.var24h,
                    timeframe: tf,
                    timeframeVariation,
                    closes: close,
                    highs: high,
                    lows: low,
                    volumes: vol,
                    atrSeries: indicators.atrSeries,
                    upperBB: indicators.bb.upper,
                    lowerBB: indicators.bb.lower,
                    upperKC: indicators.kc.upper,
                    lowerKC: indicators.kc.lower,
                    adxSeries: indicators.adxSeries,
                    vwapSeries: indicators.vwapSeries,
                    ema9: indicators.ema9Series,
                    ema21: indicators.ema21Series,
                    stochasticK: indicators.stochasticK,
                    stochasticD: indicators.stochasticD,
                    willrSeries: indicators.willrSeries,
                    cciSeries: indicators.cciSeries,
                    obvSeries: indicators.obvSeries,
                    equity: CFG.accountEquity,
                    riskPct: CFG.riskPerTrade,
                    variationByTimeframe: variationMetrics,
                    timeframeOrder: TIMEFRAMES
                });
                const consolidated = [];
                const dedupMap = new Map();
                for (const alert of alerts) {
                    const key = [alert.level, alert.category, alert.msg].join('|');
                    const entry = dedupMap.get(key);
                    if (entry) {
                        entry.count += 1;
                    } else {
                        const withCount = { ...alert, count: 1 };
                        dedupMap.set(key, withCount);
                        consolidated.push(withCount);
                    }
                }
                const actionable = consolidated.filter(a =>
                    !a.msg.startsWith('ðŸ’° PreÃ§o') &amp;&amp; !a.msg.startsWith('ðŸ“Š Var'));
                timeframeMeta.set(tf, {
                    ...meta,
                    consolidated,
                    actionable,
                });
            }
        } catch (e) {
            log.error({ fn: 'runOnceForAsset', err: e }, 'Processing error');
            await notifyOps(`Processing error for ${asset.key} ${tf}: ${e.message || e}`);
        }
    });

    await Promise.all(timeframeTasks);

    if (enableAlerts) {
        const variationByTimeframe = collectVariationMetrics({ snapshots });

        const timeframeSummaries = TIMEFRAMES.map(tf => {
            const meta = timeframeMeta.get(tf);
            if (!meta || meta.actionable.length === 0) {
                return null;
            }
            return {
                timeframe: tf,
                guidance: meta.guidance,
                decision: meta.decision,
                alerts: meta.consolidated,
                forecast: meta.forecast
            };
        }).filter(Boolean);

        if (timeframeSummaries.length > 0) {
            const alertMsg = buildAssetAlertMessage({
                assetKey: asset.key,
                mention: "@here",
                timeframeSummaries,
                variationByTimeframe,
                timeframeOrder: TIMEFRAMES
            });
            if (alertMsg) {
                const hash = buildHash(alertMsg);
                const windowMs = CFG.alertDedupMinutes * 60 * 1000;
                const scope = "aggregate";
                if (shouldSend({ asset: asset.key, tf: scope, hash }, windowMs)) {
                    enqueueAlertPayload({ asset: asset.key, timeframe: scope, message: alertMsg });
                }
            }
        }
    }

    saveStore();
    let summary = null;
    if (snapshots["4h"]) {
        summary = buildSummary({ assetKey: asset.key, snapshots });
        if (enableAnalysis &amp;&amp; shouldPostAnalysis) {
            const analysisResult = await postAnalysis(asset.key, "4h", summary);
            if (!analysisResult?.posted) {
                const log = withContext(logger, { asset: asset.key, timeframe: '4h' });
                log.warn({ fn: 'runOnceForAsset', reportPath: analysisResult?.path }, 'report upload failed');
            }
        }
    }
    if (enableCharts &amp;&amp; shouldPostCharts) {
        const uploads = [...chartPaths];
        if (CFG.forecasting?.charts?.appendToUploads) {
            uploads.push(...forecastChartPaths);
        }
        if (uploads.length > 0) {
            const chartsSent = await postCharts(uploads);
            if (!chartsSent) {
                const log = withContext(logger, { asset: asset.key });
                log.warn({ fn: 'runOnceForAsset' }, 'chart upload failed');
            }
        }
    }
    return { snapshots, summary, chartPaths, forecastCharts: forecastChartPaths };
}

/**
 * Executes the processing pipeline for all configured assets respecting concurrency limits.
 * @returns {Promise}
 */
async function runAll() {
    await runAssetsSafely({
        assets: ASSETS,
        limitFactory: () => pLimit(calcConcurrency()),
        runAsset: runOnceForAsset,
        logger,
    });
    await flushAlertQueue({
        sender: async ({ message, options }) => {
            await sendDiscordAlert(message, options);
        },
        timeframeOrder: TIMEFRAMES
    });
    try {
        const growthSummary = await runPortfolioGrowthSimulation();
        if (growthSummary?.uploads?.length) {
            const uploaded = await postCharts(growthSummary.uploads);
            if (!uploaded) {
                const log = withContext(logger, { fn: "runAll" });
                log.warn({ uploads: growthSummary.uploads }, "Failed to post portfolio growth chart");
            }
        }
        if (CFG.portfolioGrowth?.discord?.enabled &amp;&amp; growthSummary?.discord?.message) {
            const log = withContext(logger, { fn: "runAll" });
            const options = {};
            const webhook = CFG.portfolioGrowth.discord.webhookUrl?.trim();
            const channelId = CFG.portfolioGrowth.discord.channelId?.trim();
            if (webhook) {
                options.webhookUrl = webhook;
            }
            if (channelId) {
                options.channelId = channelId;
            }
            const delivered = await sendDiscordAlert(growthSummary.discord.message, options);
            if (!delivered) {
                log.warn({ fn: "runAll" }, 'Failed to dispatch portfolio growth summary');
            }
        }
    } catch (error) {
        const log = withContext(logger, { fn: "runAll" });
        log.warn({ err: error }, "Portfolio growth simulation failed");
    }
}

const DAILY_ALERT_SCOPE = 'daily';
const DAILY_ALERT_KEY = 'analysis';

/**
 * Generates and posts the macro daily analysis report when new data is available.
 * @returns {Promise}
 */
async function runDailyAnalysis() {
    const log = withContext(logger, { asset: 'DAILY', timeframe: '1d' });
    try {
        const dailyCandles = await fetchDailyCloses(ASSETS[0].binance, 2);
        const lastTime = dailyCandles.at(-1)?.t?.getTime?.();
        const key = "DAILY:1d";
        if (lastTime != null &amp;&amp; getSignature(key) === lastTime) {
            return;
        }
        if (lastTime != null) {
            updateSignature(key, lastTime);
            saveStore();
        }
        const report = await runAgent();
        const events = await fetchEconomicEvents();
        let finalReport = report;
        if (events.length > 0) {
            const fmt = d => new Date(d).toLocaleString("en-US", { timeZone: CFG.tz, hour12: false });
            const header = "**Upcoming high-impact economic events**";
            const lines = events.map(e => `- ${fmt(e.date)}: ${e.title} (${e.country})`);
            finalReport = [header, ...lines, "", report].join("\n");
        }
        if (CFG.enableReports) {
            const hash = buildHash(finalReport);
            if (getAlertHash(DAILY_ALERT_SCOPE, DAILY_ALERT_KEY) === hash) {
                log.info({ fn: 'runDailyAnalysis' }, 'Skipping daily analysis post (duplicate hash)');
                return;
            }
            const analysisResult = await postAnalysis("DAILY", "1d", finalReport);
            if (analysisResult?.posted) {
                updateAlertHash(DAILY_ALERT_SCOPE, DAILY_ALERT_KEY, hash);
                saveStore();
            } else {
                log.warn({ fn: 'runDailyAnalysis', reportPath: analysisResult?.path }, 'report upload failed');
            }
        }
    } catch (e) {
        log.error({ fn: 'runDailyAnalysis', err: e }, 'Error in daily analysis');
        await notifyOps(`Error in daily analysis: ${e.message || e}`);
    }
}

const DAY_MS = 24 * 60 * 60 * 1000;

/**
 * Converts a date into a YYYY-MM month key within the provided timezone.
 * @param {Date} date - Date to convert.
 * @param {string} timeZone - IANA timezone identifier.
 * @returns {string} Month key string.
 */
function toMonthKey(date, timeZone) {
    try {
        const formatter = new Intl.DateTimeFormat('en-CA', { timeZone, year: 'numeric', month: '2-digit' });
        const parts = formatter.formatToParts(date);
        const year = parts.find(part => part.type === 'year')?.value;
        const month = parts.find(part => part.type === 'month')?.value;
        if (year &amp;&amp; month) {
            return `${year}-${month}`;
        }
    } catch (_) {
        // Fall back to UTC computation below.
    }
    const fallbackYear = date.getUTCFullYear();
    const fallbackMonth = String(date.getUTCMonth() + 1).padStart(2, '0');
    return `${fallbackYear}-${fallbackMonth}`;
}

/**
 * Parses an ISO string and converts it into a month key in the specified timezone.
 * @param {string} isoString - ISO date string.
 * @param {string} timeZone - IANA timezone identifier.
 * @returns {string|null} Month key or null when parsing fails.
 */
function monthKeyFromIso(isoString, timeZone) {
    if (!isoString) return null;
    const parsed = new Date(isoString);
    if (Number.isNaN(parsed.getTime())) {
        return null;
    }
    return toMonthKey(parsed, timeZone);
}

/**
 * Computes the month key for the month prior to the provided date.
 * @param {Date} referenceDate - Reference date.
 * @param {string} timeZone - IANA timezone identifier.
 * @returns {string} Month key string.
 */
function previousMonthKey(referenceDate, timeZone) {
    const previousDay = new Date(referenceDate.getTime() - DAY_MS);
    return toMonthKey(previousDay, timeZone);
}

/**
 * Aggregates weekly performance data for all assets and persists a snapshot.
 * @returns {Promise}
 */
async function generateWeeklySnapshot() {
    const log = withContext(logger, { fn: 'generateWeeklySnapshot' });
    try {
        const dailyCandles = await fetchDailyCloses(ASSETS[0].binance, 8);
        const lastTime = dailyCandles.at(-1)?.t?.getTime?.();
        const signatureKey = 'WEEKLY:SNAPSHOT';
        const weekMs = 7 * DAY_MS;
        const weekSignature = lastTime != null ? Math.floor(lastTime / weekMs) : null;
        if (weekSignature != null &amp;&amp; getSignature(signatureKey) === weekSignature) {
            log.debug({ weekSignature }, 'Weekly snapshot already stored for current window.');
            return;
        }

        const assets = {};
        for (const asset of ASSETS) {
            const assetLog = withContext(logger, { fn: 'generateWeeklySnapshot', asset: asset.key });
            try {
                const candles = await fetchDailyCloses(asset.binance, 8);
                const last = candles.at(-1);
                const prev = candles.at(-8);
                const variation = (last?.c != null &amp;&amp; prev?.c != null)
                    ? ((last.c / prev.c - 1) * 100)
                    : null;
                assets[asset.key] = {
                    close: last?.c ?? null,
                    variationPct: Number.isFinite(variation) ? Number.parseFloat(variation.toFixed(2)) : null,
                };
            } catch (err) {
                assetLog.warn({ err }, 'Failed to compute weekly variation.');
                assets[asset.key] = { error: true };
            }
        }

        const performance = reportWeeklyPerf();
        const entry = {
            generatedAt: new Date().toISOString(),
            weekSignature,
            timezone: CFG.tz,
            assets,
            performance,
        };
        await saveWeeklySnapshot(entry);
        if (weekSignature != null) {
            updateSignature(signatureKey, weekSignature);
            saveStore();
        }
        log.info({ weekSignature }, 'Saved weekly performance snapshot.');
    } catch (err) {
        log.error({ err }, 'Error generating weekly snapshot');
        await notifyOps(`Error generating weekly snapshot: ${err.message || err}`);
    }
}

/**
 * Builds and dispatches the monthly performance report based on weekly snapshots.
 * @returns {Promise}
 */
async function compileMonthlyPerformanceReport() {
    const log = withContext(logger, { fn: 'compileMonthlyPerformanceReport' });
    try {
        const now = new Date();
        const monthKey = previousMonthKey(now, CFG.tz);
        if (!monthKey) {
            log.warn('Unable to determine month key for monthly report.');
            return;
        }

        const signatureKey = `MONTHLY:${monthKey}`;
        if (getSignature(signatureKey) === monthKey) {
            log.debug({ monthKey }, 'Monthly report already processed.');
            return;
        }

        const snapshots = await loadWeeklySnapshots();
        const monthEntries = snapshots.filter(entry => monthKeyFromIso(entry?.generatedAt, CFG.tz) === monthKey);
        if (monthEntries.length === 0) {
            log.info({ monthKey }, 'No weekly snapshots available for monthly report.');
            return;
        }

        const assetStats = new Map();
        for (const entry of monthEntries) {
            for (const [assetKey, stats] of Object.entries(entry.assets ?? {})) {
                const rawValue = stats?.variationPct ?? stats?.performancePct ?? stats?.variation ?? null;
                const variation = typeof rawValue === 'string' ? Number.parseFloat(rawValue) : rawValue;
                if (!Number.isFinite(variation)) {
                    continue;
                }
                if (!assetStats.has(assetKey)) {
                    assetStats.set(assetKey, { total: 0, count: 0, min: variation, max: variation });
                }
                const agg = assetStats.get(assetKey);
                agg.total += variation;
                agg.count += 1;
                agg.min = Math.min(agg.min, variation);
                agg.max = Math.max(agg.max, variation);
            }
        }

        const ordered = Array.from(assetStats.entries())
            .filter(([, value]) => value.count > 0)
            .map(([assetKey, value]) => {
                const average = value.total / value.count;
                return {
                    assetKey,
                    average,
                    count: value.count,
                    min: value.min,
                    max: value.max,
                };
            })
            .sort((a, b) => b.average - a.average);

        if (ordered.length === 0) {
            log.info({ monthKey }, 'No valid asset data found for monthly report.');
            updateSignature(signatureKey, monthKey);
            saveStore();
            return;
        }

        const labels = ordered.map(item => item.assetKey);
        const values = ordered.map(item => item.average);
        let chartPath;
        try {
            chartPath = await renderMonthlyPerformanceChart({ monthKey, labels, values });
        } catch (err) {
            log.error({ err, monthKey }, 'Failed to render monthly performance chart.');
        }

        const lines = [
            `ðŸ“Š RelatÃ³rio mensal ${monthKey}`,
            '',
            `Semanas consideradas: ${monthEntries.length}`,
        ];
        for (const item of ordered) {
            lines.push(`- ${item.assetKey}: mÃ©dia ${item.average.toFixed(2)}% (min ${item.min.toFixed(2)}%, mÃ¡x ${item.max.toFixed(2)}%, amostras=${item.count})`);
        }
        const content = lines.join("\n");
        const posted = await postMonthlyReport({ content, filePath: chartPath });
        if (posted) {
            updateSignature(signatureKey, monthKey);
            saveStore();
            log.info({ monthKey }, 'Monthly performance report sent.');
        } else {
            log.warn({ monthKey }, 'Monthly performance report was not sent.');
        }
    } catch (err) {
        log.error({ err }, 'Error compiling monthly performance report');
        await notifyOps(`Error compiling monthly performance report: ${err.message || err}`);
    }
}

const runningAssets = new Set();
/**
 * Queues a background run for the given asset if one is not already in progress.
 * @param {{key: string}} asset - Asset metadata.
 * @returns {void}
 */
function scheduleRun(asset) {
    if (runningAssets.has(asset.key)) return;
    runningAssets.add(asset.key);
    runOnceForAsset(asset).finally(() => runningAssets.delete(asset.key));
}

/**
 * Generates an analysis summary when requested by the Discord slash command.
 * @param {Object} params - Command payload.
 * @param {Object} params.asset - Asset metadata.
 * @param {string} params.timeframe - Timeframe requested by the user.
 * @returns {Promise} Generated summary text.
 */
async function handleAnalysisSlashCommand({ asset, timeframe }) {
    const { summary } = await runOnceForAsset(asset, {
        enableCharts: false,
        postCharts: false,
        enableAlerts: false,
        enableAnalysis: true,
        postAnalysis: false
    });
    return summary;
}

if (!ONCE) {
    const intervals = Array.from(new Set(TIMEFRAMES.map(tf => tfToInterval(tf))));
    const pairs = [];
    ASSETS.forEach(a => intervals.forEach(i => pairs.push({ symbol: a.binance, interval: i })));
    streamKlines(pairs, (symbol) => {
        const asset = ASSETS.find(a => a.binance === symbol);
        if (asset) {
            scheduleRun(asset);
        }
    });
    const scheduleLog = withContext(logger);
    const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;
    const rawDailyReportHours = Array.isArray(CFG.dailyReportHours)
        ? CFG.dailyReportHours
        : Array.isArray(CFG.dailyReportHour)
            ? CFG.dailyReportHour
            : [CFG.dailyReportHour];
    const dailyReportHours = Array.from(new Set(
        rawDailyReportHours
            .map((hour) => Number.parseInt(hour, 10))
            .filter((hour) => Number.isInteger(hour) &amp;&amp; hour >= 0 &amp;&amp; hour &lt;= 23)
    )).sort((a, b) => a - b);
    for (const hour of dailyReportHours) {
        cron.schedule(`0 ${hour} * * *`, runDailyAnalysis, { timezone: CFG.tz });
        scheduleLog.info({ fn: 'schedule', channel: 'analysis', hour }, `â±ï¸ Scheduled daily at ${hour}h (TZ=${CFG.tz})`);
    }
    cron.schedule('0 18 * * 0', generateWeeklySnapshot, { timezone: CFG.tz });
    scheduleLog.info({ fn: 'schedule' }, `â±ï¸ Scheduled weekly snapshot at 18h Sunday (TZ=${CFG.tz})`);
    cron.schedule('0 1 1 * *', compileMonthlyPerformanceReport, { timezone: CFG.tz });
    scheduleLog.info({ fn: 'schedule' }, `ðŸ“ˆ Scheduled monthly performance report on day 1 at 01h (TZ=${CFG.tz})`);
    cron.schedule('0 0 * * 0', () => {
        const log = withContext(logger, { fn: 'resetAlertHashesJob' });
        resetAlertHashes();
        saveStore();
        log.info('Reset stored daily/weekly alert hashes');
    }, { timezone: CFG.tz });
    scheduleLog.info({ fn: 'schedule' }, 'â™»ï¸ Scheduled weekly alert hash reset');
    cron.schedule('0 0 * * *', () => pruneOlderThan(sevenDaysMs), { timezone: CFG.tz });
    scheduleLog.info({ fn: 'schedule' }, 'ðŸ§¹ Scheduled daily alert cache pruning (older than 7 days)');
    runAll();
    pruneOlderThan(sevenDaysMs);
    runDailyAnalysis();
    generateWeeklySnapshot();
    compileMonthlyPerformanceReport();
} else {
    const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;
    await runAll();
    pruneOlderThan(sevenDaysMs);
    await runDailyAnalysis();
    await generateWeeklySnapshot();
    await compileMonthlyPerformanceReport();
    if (process.env.NODE_ENV !== 'test') {
        process.exit(0);
    }
}
</code></pre></article></section></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><a href="/" class="sidebar-title sidebar-title-anchor">Crypto Daily Discord Bot API</a><div class="mobile-nav-links"></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="DiscordRateLimit.html">DiscordRateLimit</a></div><div class="sidebar-section-children"><a href="TokenBucket.html">TokenBucket</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#AssetRunner">AssetRunner</a></div><div class="sidebar-section-children"><a href="global.html#LimitExecutor">LimitExecutor</a></div><div class="sidebar-section-children"><a href="global.html#LimitFactory">LimitFactory</a></div><div class="sidebar-section-children"><a href="global.html#SnapshotMap">SnapshotMap</a></div><div class="sidebar-section-children"><a href="global.html#TimeframeSnapshot">TimeframeSnapshot</a></div><div class="sidebar-section-children"><a href="global.html#addAssetToWatch">addAssetToWatch</a></div><div class="sidebar-section-children"><a href="global.html#adx">adx</a></div><div class="sidebar-section-children"><a href="global.html#assetMetadata">assetMetadata</a></div><div class="sidebar-section-children"><a href="global.html#atr14">atr14</a></div><div class="sidebar-section-children"><a href="global.html#bollWidth">bollWidth</a></div><div class="sidebar-section-children"><a href="global.html#bollinger">bollinger</a></div><div class="sidebar-section-children"><a href="global.html#build45mCandles">build45mCandles</a></div><div class="sidebar-section-children"><a href="global.html#buildAlerts">buildAlerts</a></div><div class="sidebar-section-children"><a href="global.html#buildHash">buildHash</a></div><div class="sidebar-section-children"><a href="global.html#buildPortfolioGrowthDiscordMessage">buildPortfolioGrowthDiscordMessage</a></div><div class="sidebar-section-children"><a href="global.html#buildSnapshotForReport">buildSnapshotForReport</a></div><div class="sidebar-section-children"><a href="global.html#buildSummary">buildSummary</a></div><div class="sidebar-section-children"><a href="global.html#buildSummaryPdf">buildSummaryPdf</a></div><div class="sidebar-section-children"><a href="global.html#calcConcurrency">calcConcurrency</a></div><div class="sidebar-section-children"><a href="global.html#callOpenRouter">callOpenRouter</a></div><div class="sidebar-section-children"><a href="global.html#cci">cci</a></div><div class="sidebar-section-children"><a href="global.html#clampSentiment">clampSentiment</a></div><div class="sidebar-section-children"><a href="global.html#classifySentimentsLocal">classifySentimentsLocal</a></div><div class="sidebar-section-children"><a href="global.html#collectVariationMetrics">collectVariationMetrics</a></div><div class="sidebar-section-children"><a href="global.html#compareAssets">compareAssets</a></div><div class="sidebar-section-children"><a href="global.html#compileMonthlyPerformanceReport">compileMonthlyPerformanceReport</a></div><div class="sidebar-section-children"><a href="global.html#computeWeightedSentiment">computeWeightedSentiment</a></div><div class="sidebar-section-children"><a href="global.html#crossDown">crossDown</a></div><div class="sidebar-section-children"><a href="global.html#crossUp">crossUp</a></div><div class="sidebar-section-children"><a href="global.html#ema">ema</a></div><div class="sidebar-section-children"><a href="global.html#fetchWithRetry">fetchWithRetry</a></div><div class="sidebar-section-children"><a href="global.html#filterFreshNewsItems">filterFreshNewsItems</a></div><div class="sidebar-section-children"><a href="global.html#fmt">fmt</a></div><div class="sidebar-section-children"><a href="global.html#forecastNextClose">forecastNextClose</a></div><div class="sidebar-section-children"><a href="global.html#formatAlertMessage">formatAlertMessage</a></div><div class="sidebar-section-children"><a href="global.html#generateWeeklySnapshot">generateWeeklySnapshot</a></div><div class="sidebar-section-children"><a href="global.html#getAlertHash">getAlertHash</a></div><div class="sidebar-section-children"><a href="global.html#getAssetNews">getAssetNews</a></div><div class="sidebar-section-children"><a href="global.html#getSetting">getSetting</a></div><div class="sidebar-section-children"><a href="global.html#getSettings">getSettings</a></div><div class="sidebar-section-children"><a href="global.html#getSignature">getSignature</a></div><div class="sidebar-section-children"><a href="global.html#getWatchlist">getWatchlist</a></div><div class="sidebar-section-children"><a href="global.html#handleAnalysisSlashCommand">handleAnalysisSlashCommand</a></div><div class="sidebar-section-children"><a href="global.html#handleInteraction">handleInteraction</a></div><div class="sidebar-section-children"><a href="global.html#initBot">initBot</a></div><div class="sidebar-section-children"><a href="global.html#isBBSqueeze">isBBSqueeze</a></div><div class="sidebar-section-children"><a href="global.html#keltnerChannel">keltnerChannel</a></div><div class="sidebar-section-children"><a href="global.html#limit">limit</a></div><div class="sidebar-section-children"><a href="global.html#loadSettings">loadSettings</a></div><div class="sidebar-section-children"><a href="global.html#loadWeeklySnapshots">loadWeeklySnapshots</a></div><div class="sidebar-section-children"><a href="global.html#macd">macd</a></div><div class="sidebar-section-children"><a href="global.html#markNewsItemsAsSeen">markNewsItemsAsSeen</a></div><div class="sidebar-section-children"><a href="global.html#monthKeyFromIso">monthKeyFromIso</a></div><div class="sidebar-section-children"><a href="global.html#normalizeSentiment">normalizeSentiment</a></div><div class="sidebar-section-children"><a href="global.html#notifyOps">notifyOps</a></div><div class="sidebar-section-children"><a href="global.html#num">num</a></div><div class="sidebar-section-children"><a href="global.html#obv">obv</a></div><div class="sidebar-section-children"><a href="global.html#parabolicSAR">parabolicSAR</a></div><div class="sidebar-section-children"><a href="global.html#pct">pct</a></div><div class="sidebar-section-children"><a href="global.html#persistForecastEntry">persistForecastEntry</a></div><div class="sidebar-section-children"><a href="global.html#postAnalysis">postAnalysis</a></div><div class="sidebar-section-children"><a href="global.html#postCharts">postCharts</a></div><div class="sidebar-section-children"><a href="global.html#postMonthlyReport">postMonthlyReport</a></div><div class="sidebar-section-children"><a href="global.html#previousMonthKey">previousMonthKey</a></div><div class="sidebar-section-children"><a href="global.html#pruneOlderThan">pruneOlderThan</a></div><div class="sidebar-section-children"><a href="global.html#recordPerf">recordPerf</a></div><div class="sidebar-section-children"><a href="global.html#removeAssetFromWatch">removeAssetFromWatch</a></div><div class="sidebar-section-children"><a href="global.html#renderChartPNG">renderChartPNG</a></div><div class="sidebar-section-children"><a href="global.html#renderForecastChart">renderForecastChart</a></div><div class="sidebar-section-children"><a href="global.html#renderMonthlyPerformanceChart">renderMonthlyPerformanceChart</a></div><div class="sidebar-section-children"><a href="global.html#renderPortfolioGrowthChart">renderPortfolioGrowthChart</a></div><div class="sidebar-section-children"><a href="global.html#reportWeeklyPerf">reportWeeklyPerf</a></div><div class="sidebar-section-children"><a href="global.html#resetAlertHashes">resetAlertHashes</a></div><div class="sidebar-section-children"><a href="global.html#resetSettings">resetSettings</a></div><div class="sidebar-section-children"><a href="global.html#roundThreshold">roundThreshold</a></div><div class="sidebar-section-children"><a href="global.html#rsi">rsi</a></div><div class="sidebar-section-children"><a href="global.html#runAgent">runAgent</a></div><div class="sidebar-section-children"><a href="global.html#runAll">runAll</a></div><div class="sidebar-section-children"><a href="global.html#runAssetsSafely">runAssetsSafely</a></div><div class="sidebar-section-children"><a href="global.html#runDailyAnalysis">runDailyAnalysis</a></div><div class="sidebar-section-children"><a href="global.html#runOnceForAsset">runOnceForAsset</a></div><div class="sidebar-section-children"><a href="global.html#saveStore">saveStore</a></div><div class="sidebar-section-children"><a href="global.html#saveWeeklySnapshot">saveWeeklySnapshot</a></div><div class="sidebar-section-children"><a href="global.html#scheduleRun">scheduleRun</a></div><div class="sidebar-section-children"><a href="global.html#scoreHeuristic">scoreHeuristic</a></div><div class="sidebar-section-children"><a href="global.html#searchWeb">searchWeb</a></div><div class="sidebar-section-children"><a href="global.html#semaforo">semaforo</a></div><div class="sidebar-section-children"><a href="global.html#sendDiscordAlert">sendDiscordAlert</a></div><div class="sidebar-section-children"><a href="global.html#setSetting">setSetting</a></div><div class="sidebar-section-children"><a href="global.html#shouldSend">shouldSend</a></div><div class="sidebar-section-children"><a href="global.html#sma">sma</a></div><div class="sidebar-section-children"><a href="global.html#sparkline">sparkline</a></div><div class="sidebar-section-children"><a href="global.html#stochastic">stochastic</a></div><div class="sidebar-section-children"><a href="global.html#streamKlines">streamKlines</a></div><div class="sidebar-section-children"><a href="global.html#tfToInterval">tfToInterval</a></div><div class="sidebar-section-children"><a href="global.html#toMonthKey">toMonthKey</a></div><div class="sidebar-section-children"><a href="global.html#trendFromMAs">trendFromMAs</a></div><div class="sidebar-section-children"><a href="global.html#updateAlertHash">updateAlertHash</a></div><div class="sidebar-section-children"><a href="global.html#updateSignature">updateSignature</a></div><div class="sidebar-section-children"><a href="global.html#volumeDivergence">volumeDivergence</a></div><div class="sidebar-section-children"><a href="global.html#vwap">vwap</a></div><div class="sidebar-section-children"><a href="global.html#williamsR">williamsR</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#dark-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>