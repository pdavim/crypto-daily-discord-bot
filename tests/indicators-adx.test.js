import { describe, it, expect } from "vitest";
import { adx } from "../src/indicators.js";

const highs = [118509.0, 118340.0, 119798.0, 119826.0, 119267.0, 118775.0, 118904.0, 116054.0, 114008.0, 114774.0, 115732.0, 115106.0,
    115729.0, 117675.0, 117661.0, 117929.0, 119310.0, 122312.0, 120304.0, 123715.0, 124517.0, 119336.0, 118057.0, 118626.0, 117622.0,
    116765.0, 114618.0, 114801.0, 117421.0, 116985.0, 115626.0, 113645.0, 112400.0, 112646.0, 113473.0, 112654.0, 108924.0, 109503.0,
    109907.0, 111775.0, 112615.0, 112223.0, 113402.0, 111314.0, 111597.0, 112935.0, 113279.0, 114348.0, 115533.0, 116805.0, 116364.0,
    116216.0, 116786.0, 117006.0, 117323.0, 117968.0, 117506.0, 116197.0, 115901.0, 115435.0];

const lows = [114518.0, 117196.0, 117888.0, 117400.0, 116928.0, 115784.0, 115512.0, 112680.0, 111987.0, 111919.0, 114129.0, 112660.0,
    113365.0, 114280.0, 115896.0, 116350.0, 116490.0, 118043.0, 118214.0, 118940.0, 117201.0, 116856.0, 117252.0, 117266.0, 114706.0,
    112702.0, 112353.0, 111972.0, 111658.0, 114536.0, 110671.0, 109283.0, 108717.0, 110381.0, 110876.0, 107488.0, 107389.0, 108092.0,
    107270.0, 108426.0, 110550.0, 109343.0, 110226.0, 110021.0, 110212.0, 110624.0, 110768.0, 110932.0, 113460.0, 114770.0, 115177.0,
    115190.0, 114421.0, 114776.0, 114747.0, 116144.0, 115144.0, 115479.0, 115258.0, 111986.0];

const closes = [117653.0, 117962.0, 119469.0, 118051.0, 117926.0, 117834.0, 115750.0, 113243.0, 112522.0, 114226.0, 115051.0, 114133.0,
    115030.0, 117515.0, 116675.0, 116495.0, 119310.0, 118712.0, 120107.0, 123360.0, 118394.0, 117446.0, 117460.0, 117490.0, 116265.0,
    112870.0, 114263.0, 112472.0, 116891.0, 115392.0, 113478.0, 110136.0, 111788.0, 111273.0, 112581.0, 108362.0, 108827.0, 108269.0,
    109244.0, 111238.0, 111759.0, 110747.0, 110669.0, 110223.0, 111144.0, 112098.0, 111531.0, 113988.0, 115533.0, 116108.0, 115981.0,
    115342.0, 115387.0, 116837.0, 116477.0, 117125.0, 115702.0, 115759.0, 115292.0, 113073.0];

const expectedAdx = [null, null, null, null, null, null, null, null, null, null, null, null, null, 3.463292, 3.463292, 3.225178, 4.07038,
    6.445071, 8.650141, 11.84695, 13.461965, 14.71469, 15.877935, 17.189113, 16.63205, 15.82791, 15.248077, 14.895601, 14.45648,
    14.048724, 14.192768, 14.812678, 15.577744, 16.146145, 16.195375, 17.388045, 18.524474, 19.230835, 20.158014, 19.933747,
    19.284874, 19.16263, 18.431793, 17.841479, 17.137633, 16.04892, 15.211156, 14.955305, 15.245253, 16.024106, 16.747327, 17.418889,
    17.480472, 17.647708, 17.965789, 18.587399, 18.357842, 18.144682, 17.762614, 17.69621];

describe("adx", () => {
    it("calculates values matching Wilder's ADX smoothing", () => {
        const result = adx(highs, lows, closes, 14);
        expect(result).toHaveLength(closes.length);
        result.forEach((value, idx) => {
            const expected = expectedAdx[idx];
            if (expected == null) {
                expect(value).toBeNull();
            } else {
                expect(value).toBeCloseTo(expected, 5);
            }
        });
    });
});
